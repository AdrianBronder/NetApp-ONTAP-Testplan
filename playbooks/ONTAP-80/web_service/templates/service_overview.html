{% extends "base_enduser.html" %}

{% block title %}Service Overview{% endblock %}

{% block content %}
<div class="container mt-0">
    <h1 class="my-4">Service Overview for {{ company }}</h1>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Department</th>
                <th>Local Versioning</th>
                <th>Backup</th>
                <th>Ransom-ware Protected</th>
                <th>Data Pipeline</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for department in departmentConsumedServices %}
                <tr>
                    <td>{{ department.name }}</td>
                    <td class="{% if department.local_versioning != 'disabled' %}bold-green{% endif %}">
                        {{ department.local_versioning }}
                    </td>
                    <td class="{% if department.backup != 'disabled' %}bold-green{% endif %}">
                        {{ department.backup }}
                    </td>
                    <td class="{% if department.ransomware_protection != 'disabled' %}bold-green{% endif %}">
                        {{ department.ransomware_protection }}
                    </td>
                    <td class="{% if department.data_pipeline != 'disabled' %}bold-green{% endif %}">
                        {{ department.data_pipeline }}
                    </td>
                    <td>
                        <button class="btn btn-primary modify-service-btn" data-department="{{ department.name }}" data-local-versioning="{{ department.local_versioning }}" data-backup="{{ department.backup }}" data-ransomware="{{ department.ransomware_protection }}" data-pipeline="{{ department.data_pipeline }}">Modify Service</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal for modifying service options -->
<div class="modal fade" id="modifyServiceModal" tabindex="-1" role="dialog" aria-labelledby="modifyServiceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="modifyServiceForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="modifyServiceModalLabel">Modify Service</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="departmentName" name="departmentName">
                    <div class="form-group">
                        <label for="localVersioning">Local Versioning</label>
                        <select class="form-control" id="localVersioning" name="localVersioning">
                            <option value="disabled">Disabled</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                            <option value="ultimate">Ultimate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="backup">Backup</label>
                        <select class="form-control" id="backup" name="backup">
                            <option value="disabled">Disabled</option>
                            <option value="standard">Standard</option>
                            <option value="premium">Premium</option>
                            <option value="ultimate">Ultimate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ransomwareProtection">Ransomware Protection</label>
                        <select class="form-control" id="ransomwareProtection" name="ransomwareProtection">
                            <option value="disabled">Disabled</option>
                            <option value="enabled">Enabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataPipeline">Data Pipeline</label>
                        <select class="form-control" id="dataPipeline" name="dataPipeline">
                            <option value="disabled">Disabled</option>
                            <option value="enabled">Enabled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Include the second block with pie charts and the list of shares and quota details -->
<div class="container">
    <h1 class="my-4">Storage Units</h1>
    <div class="charts-container">
        <div class="chart-container">
            <canvas id="quotaSizePieChart"></canvas>
        </div>
        <div class="chart-container">
            <canvas id="quotaCountPieChart"></canvas>
        </div>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Department</th>
                <th>Share Name</th>
                <th>Requested Size (GiB)</th>
                <th>Used Size (GiB)</th>
            </tr>
        </thead>
        <tbody>
            {% for quota in quotaReport %}
                <tr>
                    <td>{{ quota.volume.name | replace('ontap_80_', '') }}</td>
                    <td>{{ quota.qtree.name }}</td>
                    <td>{{ '{:0.2f}'.format(quota.space.hard_limit / 1024**3) }}</td>
                    <td>{{ '{:0.2f}'.format(quota.space.used.total / 1024**3) }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block styles %}
<style>
    .charts-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
    }
    .chart-container {
        width: 300px;
        height: 300px;
    }
    .chart-container canvas {
        width: 100% !important;
        height: 100% !important;
    }
    .container.mt-0 {
        margin-top: 0 !important;
    }
    .modal-content {
        background-color: #2e2e2e;
        color: #cfcfcf;
    }
    .modal-header, .modal-footer {
        border: none;
    }
    .modal-header .close {
        color: #cfcfcf;
    }
    .form-control {
        background-color: #3e3e3e;
        color: #cfcfcf;
        border: 1px solid #555;
    }
    .form-control:focus {
        background-color: #3e3e3e;
        color: #cfcfcf;
        border: 1px solid #2196F3;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('.modify-service-btn').on('click', function() {
            var department = $(this).data('department');
            var localVersioning = $(this).data('local-versioning');
            var backup = $(this).data('backup');
            var ransomware = $(this).data('ransomware');
            var pipeline = $(this).data('pipeline');

            $('#departmentName').val(department);
            $('#localVersioning').val(localVersioning);
            $('#backup').val(backup);
            $('#ransomwareProtection').val(ransomware);
            $('#dataPipeline').val(pipeline);

            $('#modifyServiceModal').modal('show');
        });

        $('#modifyServiceForm').on('submit', function(event) {
            event.preventDefault();
            var formData = $(this).serialize();
            // Make an AJAX request to update the service options
            $.ajax({
                type: 'POST',
                url: '/modify_service',  // Define this route in your Flask app
                data: formData,
                success: function(response) {
                    // Handle success response
                    alert('Service options updated successfully!');
                    $('#modifyServiceModal').modal('hide');
                    location.reload();  // Reload the page to reflect changes
                },
                error: function(response) {
                    // Handle error response
                    alert('Failed to update service options.');
                }
            });
        });
    });
</script>
{% endblock %}